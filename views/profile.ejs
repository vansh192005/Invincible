<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
        integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <header>
        <nav>
            <h3>INVINCIBLE</h3>
            <button class="hamburger">
                <i class="fa-solid fa-bars"></i>
            </button>
        </nav>
        <div class="hero-section">
            <h1>Welcome <%= user.username %>
            </h1>
            <p>Treks for which you have registered</p>
        </div>
    </header>

    <!-- Sidebar -->
    <%- include("partials/sidebar") %>

        <main>
            <div class="event-container">
                <% bookings.forEach((booking, index)=> { %>
                    <div class="event-card">
                        <div class="trek-description">
                            <h3>
                                <%= booking.title %>
                            </h3>
                            <p>
                                <%= booking.tagline %>
                            </p>
                            <p>Date: <%= new Date(booking.event_date).toDateString() %>
                            </p>
                            <p>Duration: <%= booking.duration %>
                            </p>
                            <p>Difficulty: <%= booking.difficulty %>
                            </p>
                            <p>Price: â‚¹<%= booking.price %>
                            </p>
                        </div>

                        <div class="user-details">
                            <h3>Participants (<%= booking.participants.length %>)</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Age</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% booking.participants.forEach((p, i)=> { %>
                                        <tr>
                                            <td>
                                                <%= i+1 %>
                                            </td>
                                            <td>
                                                <%= p.first_name %>
                                                    <%= p.last_name %>
                                            </td>
                                            <td>
                                                <% const birthYear=new Date(p.birthdate).getFullYear(); const age=new
                                                    Date().getFullYear() - birthYear; %>
                                                    <%= age %> years
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>

                        <div class="crud_buttons">
                            <!-- Update button -->
                            <button type="button" class="update-btn" 
                                data-id="<%= booking.id %>"
                                data-title="<%= booking.title %>" data-date="<%= booking.date %>"
                                data-price="<%= booking.price %>"
                                data-participants='<%= JSON.stringify(booking.participants) %>'>
                                Update
                            </button>

                            <!-- Delete button -->
                            <form action="/delete-booking/<%= booking.booking_id %>?_method=DELETE" method="POST"
                                onsubmit="return confirm('Are you sure you want to delete this booking?');">
                                <button type="submit">Delete</button>
                            </form>
                        </div>

                    </div>

                    <% }) %>
            </div>
        </main>

        <!-- Modal -->
        <div id="updateBookingModal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>Update Registration</h2>
                <% bookings.forEach(booking=> { %>
                    <form id="updateBookingForm" action="/update-booking/<%= booking.booking_id %>?_method=PATCH"
                        method="POST">
                        <input type="hidden" name="_method" value="PATCH">
                        <input id="updateBookingId" type="hidden" name="booking_id" value="">

                        <div class="participants-selector">
                            <label>Select Participants:</label>
                            <div id="updateParticipantsButtons"></div>
                        </div>

                        <div id="updateParticipantsForms"></div>

                        <button id="updateSubmitBtn" type="submit">Update</button>

                    </form>
                    <% }) %>
            </div>
        </div>


        <script src="/profile.js"></script>

</body>

</html>